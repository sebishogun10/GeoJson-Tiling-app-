<!DOCTYPE html>
<html>
  <head>
    <title>Tile Viewer</title>
    <!-- Leaflet CSS -->
    <link
      rel="stylesheet"
      href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    />
    <!-- Tailwind CSS -->
    <link
      href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css"
      rel="stylesheet"
    />
    <style>
      #map {
        height: 800px;
        width: 100%;
      }
      .loading-overlay {
        background: rgba(255, 255, 255, 0.8);
        backdrop-filter: blur(5px);
      }
    </style>
  </head>
  <body class="bg-gray-100">
    <div class="container mx-auto p-4">
      <div class="bg-white rounded-lg shadow-lg p-4 mb-4">
        <h1 class="text-2xl font-bold mb-4">Tile Viewer</h1>

        <div id="loginSection" class="mb-4">
          <button
            onclick="login()"
            class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600"
          >
            Login with Keycloak
          </button>
          <span id="loginStatus" class="ml-2"></span>
        </div>

        <div class="mb-4">
          <textarea
            id="geoJsonInput"
            class="w-full h-32 p-2 border rounded"
            placeholder="Enter GeoJSON here..."
          >
{
  "type": "Feature",
  "geometry": {
    "type": "Polygon",
    "coordinates": [[
      [-2.2487, 53.4808],
      [-2.2487, 53.4858],
      [-2.2387, 53.4858],
      [-2.2387, 53.4808],
      [-2.2487, 53.4808]
    ]]
  }
}</textarea
          >
        </div>

        <button
          id="generateBtn"
          class="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600"
          disabled
        >
          Generate Tiles
        </button>
      </div>

      <div class="relative bg-white rounded-lg shadow-lg">
        <div id="map"></div>

        <div
          id="loadingOverlay"
          class="hidden loading-overlay absolute inset-0 flex items-center justify-center"
        >
          <div class="text-center">
            <div class="loader mb-2">Loading...</div>
            <div id="progress" class="text-lg"></div>
          </div>
        </div>
      </div>

      <div
        id="stats"
        class="fixed top-4 right-4 bg-white p-4 rounded-lg shadow-lg"
      ></div>
    </div>

    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Turf.js -->
    <script src="https://cdn.jsdelivr.net/npm/@turf/turf@6/turf.min.js"></script>
    <!-- Leaflet.VectorGrid -->
    <script src="https://unpkg.com/leaflet.vectorgrid@1.3.0/dist/Leaflet.VectorGrid.bundled.js"></script>

    <script>
      let map, token;
      let renderedFeatures = [];
      let vectorGridLayer;

      function initMap() {
        map = L.map("map").setView([53.4808, -2.2487], 13);
        L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
          maxZoom: 19,
          attribution: "Â© OpenStreetMap contributors",
        }).addTo(map);
      }

      function login() {
        const nonce = Math.random().toString(36);
        localStorage.setItem("nonce", nonce);

        window.location.href =
          "http://localhost:8180/realms/polygon-tiling/protocol/openid-connect/auth" +
          "?response_type=token" +
          "&client_id=tile-client" +
          "&redirect_uri=" +
          encodeURIComponent(window.location.origin) +
          "&scope=openid profile" +
          "&nonce=" +
          nonce;
      }

      function checkToken() {
        if (window.location.hash) {
          const match = window.location.hash.match(/access_token=([^&]*)/);
          if (match) {
            token = match[1];
            document.getElementById("loginStatus").textContent =
              "Logged in successfully";
            document.getElementById("generateBtn").disabled = false;
            return true;
          }
        }
        return false;
      }

      function startLoading() {
        document.getElementById("loadingOverlay").classList.remove("hidden");
        renderedFeatures = [];
      }

      function finishLoading() {
        document.getElementById("loadingOverlay").classList.add("hidden");
        document.getElementById(
          "stats"
        ).textContent = `Total tiles: ${renderedFeatures.length}`;

        if (renderedFeatures.length > 0) {
          const bbox = turf.bbox({
            type: "FeatureCollection",
            features: renderedFeatures,
          });
          const southWest = L.latLng(bbox[1], bbox[0]);
          const northEast = L.latLng(bbox[3], bbox[2]);
          const bounds = L.latLngBounds(southWest, northEast);
          map.fitBounds(bounds);
        }
      }

      document
        .getElementById("generateBtn")
        .addEventListener("click", async () => {
          const geoJson = document.getElementById("geoJsonInput").value;
          if (!geoJson || !token) return;

          startLoading();

          try {
            const response = await fetch("/api/v1/tiles", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
                Authorization: `Bearer ${token}`,
              },
              body: geoJson,
            });

            if (!response.ok) {
              throw new Error(`HTTP error! status: ${response.status}`);
            }

            const data = await response.json();

            if (data && data.features) {
              renderedFeatures = data.features;

              if (vectorGridLayer) {
                map.removeLayer(vectorGridLayer);
                vectorGridLayer = null;
              }

              vectorGridLayer = L.vectorGrid
                .slicer(data, {
                  rendererFactory: L.canvas.tile,
                  vectorTileLayerStyles: {
                    sliced: {
                      weight: 1,
                      color: "#FF4444",
                      fillColor: "#FF4444",
                      fillOpacity: 0.2,
                    },
                  },
                  interactive: true,
                  maxZoom: 19,
                })
                .addTo(map);

              vectorGridLayer.on("click", function (e) {
                console.log("Clicked on feature:", e.layer.properties);
              });

              finishLoading();
            }
          } catch (error) {
            console.error("Error:", error);
            document.getElementById(
              "stats"
            ).textContent = `Error: ${error.message}`;
            document.getElementById("loadingOverlay").classList.add("hidden");
          }
        });

      initMap();
      if (!checkToken()) {
        document.getElementById("loginStatus").textContent = "Please log in";
      }
    </script>
  </body>
</html>
